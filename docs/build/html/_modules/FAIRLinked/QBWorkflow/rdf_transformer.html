

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FAIRLinked.QBWorkflow.rdf_transformer &mdash; FAIRLinked 0.3.0.3 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=d1e448af"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            FAIRLinked
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../FAIRLinked.html">FAIRLinked package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">FAIRLinked</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">FAIRLinked.QBWorkflow.rdf_transformer</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for FAIRLinked.QBWorkflow.rdf_transformer</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">rdflib</span> <span class="kn">import</span> <span class="n">Graph</span><span class="p">,</span> <span class="n">Namespace</span><span class="p">,</span> <span class="n">URIRef</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">BNode</span>
<span class="kn">from</span> <span class="nn">rdflib.namespace</span> <span class="kn">import</span> <span class="n">RDF</span><span class="p">,</span> <span class="n">XSD</span><span class="p">,</span> <span class="n">DCTERMS</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">string</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">rdflib.namespace</span> <span class="kn">import</span> <span class="n">QB</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c1"># If QB is not available in your environment:</span>
    <span class="n">QB</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span><span class="s1">&#39;http://purl.org/linked-data/cube#&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">rdflib.namespace</span> <span class="kn">import</span> <span class="n">SKOS</span>
<span class="kn">from</span> <span class="nn">FAIRLinked.QBWorkflow.input_handler</span> <span class="kn">import</span> <span class="n">get_approved_id_columns</span><span class="p">,</span> <span class="n">get_identifiers</span><span class="p">,</span>  <span class="n">get_row_identifier_columns</span>

<span class="c1"># =============================================================================</span>
<span class="c1">#                            CONSTANTS</span>
<span class="c1"># =============================================================================</span>

<span class="n">EXPERIMENT_ID_COLUMN</span> <span class="o">=</span> <span class="s1">&#39;ExperimentId&#39;</span>   <span class="c1"># recognized as a dimension if present</span>
<span class="n">IS_MEASURE_FIELD</span> <span class="o">=</span> <span class="s1">&#39;IsMeasure&#39;</span>
<span class="n">UNIT_FIELD</span> <span class="o">=</span> <span class="s1">&#39;Unit&#39;</span>
<span class="n">CATEGORY_FIELD</span> <span class="o">=</span> <span class="s1">&#39;Category&#39;</span>
<span class="n">EXISTING_URI_FIELD</span> <span class="o">=</span> <span class="s1">&#39;ExistingURI&#39;</span>

<span class="n">DEFAULT_USER_PREFIX</span> <span class="o">=</span> <span class="s1">&#39;mds&#39;</span>
<span class="n">DEFAULT_DATASET_NAME</span> <span class="o">=</span> <span class="s1">&#39;SampleDataset&#39;</span>

<span class="n">ERROR_MSG_VARIABLE_NOT_FOUND</span> <span class="o">=</span> <span class="s2">&quot;Warning: Variable &#39;</span><span class="si">{var_name}</span><span class="s2">&#39; not found in variable metadata. Skipping.&quot;</span>
<span class="n">ERROR_MSG_PREFIX_NOT_FOUND</span> <span class="o">=</span> <span class="s2">&quot;Prefix &#39;</span><span class="si">{prefix}</span><span class="s2">&#39; for unit &#39;</span><span class="si">{unit_str}</span><span class="s2">&#39; not found in namespace map.&quot;</span>

<span class="c1"># =============================================================================</span>
<span class="c1">#                      FOLDER &amp; FILE SETUP</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="create_subfolders">
<a class="viewcode-back" href="../../../FAIRLinked.QBWorkflow.html#FAIRLinked.QBWorkflow.rdf_transformer.create_subfolders">[docs]</a>
<span class="k">def</span> <span class="nf">create_subfolders</span><span class="p">(</span><span class="n">root_folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description:</span>
<span class="sd">        Creates three subfolders (&#39;ttl&#39;, &#39;jsonld&#39;, &#39;hash&#39;) under the specified root folder</span>
<span class="sd">        to store Turtle files (.ttl), JSON-LD files (.jsonld), and the SHA-256 hash files (.sha256).</span>

<span class="sd">    Algorithm:</span>
<span class="sd">        1) Define a list of subfolder names: [&#39;ttl&#39;, &#39;jsonld&#39;, &#39;hash&#39;].</span>
<span class="sd">        2) For each subfolder name:</span>
<span class="sd">           - Construct a path using os.path.join(root_folder_path, folder_name).</span>
<span class="sd">           - Create the directory if it doesn&#39;t exist (os.makedirs with exist_ok=True).</span>
<span class="sd">           - Store the result in a dictionary under the same key.</span>
<span class="sd">        3) Return this dictionary of paths.</span>

<span class="sd">    Args:</span>
<span class="sd">        root_folder_path (str): The path to the parent output folder where subfolders will be created.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict:</span>
<span class="sd">            A dictionary of subfolder paths, keyed by &#39;ttl&#39;, &#39;jsonld&#39;, and &#39;hash&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">subfolders</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">folder_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ttl&quot;</span><span class="p">,</span> <span class="s2">&quot;jsonld&quot;</span><span class="p">,</span> <span class="s2">&quot;hash&quot;</span><span class="p">]:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_folder_path</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">subfolders</span><span class="p">[</span><span class="n">folder_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
    <span class="k">return</span> <span class="n">subfolders</span></div>



<div class="viewcode-block" id="compute_file_hash">
<a class="viewcode-back" href="../../../FAIRLinked.QBWorkflow.html#FAIRLinked.QBWorkflow.rdf_transformer.compute_file_hash">[docs]</a>
<span class="k">def</span> <span class="nf">compute_file_hash</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description:</span>
<span class="sd">        Computes the SHA-256 hash of a given file by reading its contents in chunks.</span>

<span class="sd">    Algorithm:</span>
<span class="sd">        1) Initialize a sha256 object (hashlib.sha256).</span>
<span class="sd">        2) Open the file in &#39;rb&#39; mode.</span>
<span class="sd">        3) Read the file in 4096-byte chunks, updating the hash object each time.</span>
<span class="sd">        4) Return the hex digest of the final hash.</span>

<span class="sd">    Args:</span>
<span class="sd">        file_path (str):</span>
<span class="sd">            The path to the file that needs hashing.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str:</span>
<span class="sd">            The SHA-256 hex digest string for the file contents.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sha256_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">byte_block</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4096</span><span class="p">),</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">sha256_hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">byte_block</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sha256_hash</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span></div>



<div class="viewcode-block" id="create_root_folder">
<a class="viewcode-back" href="../../../FAIRLinked.QBWorkflow.html#FAIRLinked.QBWorkflow.rdf_transformer.create_root_folder">[docs]</a>
<span class="k">def</span> <span class="nf">create_root_folder</span><span class="p">(</span><span class="n">output_folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">orcid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description:</span>
<span class="sd">        Creates a top-level folder named &#39;Output_{orcidDigits}_{timestamp}&#39; to store all</span>
<span class="sd">        outputs for the conversion process. Also prepares standardized strings for dataset</span>
<span class="sd">        and orcid usage throughout the process.</span>

<span class="sd">    Algorithm:</span>
<span class="sd">        1) Generate a timestamp in &#39;YYYYmmddHHMMSS&#39; format.</span>
<span class="sd">        2) Extract digits from the user&#39;s ORCID =&gt; &#39;sanitized_orcid&#39;.</span>
<span class="sd">        3) Sanitize &#39;dataset_name&#39; =&gt; &#39;sanitized_dataset_name&#39; by replacing non-word chars.</span>
<span class="sd">        4) Construct folder name =&gt; &quot;Output_{sanitized_orcid}_{timestamp}&quot;.</span>
<span class="sd">        5) os.makedirs(...) to create the folder if not existing.</span>
<span class="sd">        6) Return (root_folder_path, overall_timestamp, sanitized_dataset_name, sanitized_orcid).</span>

<span class="sd">    Args:</span>
<span class="sd">        output_folder_path (str): The parent path where we create this top-level output folder.</span>
<span class="sd">        dataset_name (str): The dataset name to be sanitized (though not used in folder name).</span>
<span class="sd">        orcid (str): The user&#39;s ORCID, from which we extract digits.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple:</span>
<span class="sd">            (</span>
<span class="sd">                root_folder_path (str): The newly created folder path,</span>
<span class="sd">                overall_timestamp (str): The run-specific timestamp (YYYYmmddHHMMSS),</span>
<span class="sd">                sanitized_dataset_name (str): The sanitized dataset name,</span>
<span class="sd">                sanitized_orcid (str): The numeric portion extracted from the ORCID.</span>
<span class="sd">            )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">overall_timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">)</span>
    <span class="n">sanitized_dataset_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\W|^(?=\d)&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">)</span>
    <span class="n">sanitized_orcid</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span> <span class="n">orcid</span><span class="p">))</span>

    <span class="n">folder_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Output_</span><span class="si">{</span><span class="n">sanitized_orcid</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">overall_timestamp</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">root_folder_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder_path</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">root_folder_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">root_folder_path</span><span class="p">,</span> <span class="n">overall_timestamp</span><span class="p">,</span> <span class="n">sanitized_dataset_name</span><span class="p">,</span> <span class="n">sanitized_orcid</span></div>



<span class="c1"># =============================================================================</span>
<span class="c1">#      WRITING A .TXT FILE DESCRIBING NAMING CONVENTIONS</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="write_naming_conventions_doc">
<a class="viewcode-back" href="../../../FAIRLinked.QBWorkflow.html#FAIRLinked.QBWorkflow.rdf_transformer.write_naming_conventions_doc">[docs]</a>
<span class="k">def</span> <span class="nf">write_naming_conventions_doc</span><span class="p">(</span><span class="n">root_folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                 <span class="n">conversion_mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                 <span class="n">orcid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                 <span class="n">overall_timestamp</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                 <span class="n">dataset_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description:</span>
<span class="sd">        Writes a text file (naming_conventions_{orcidDigits}_{timestamp}.txt) describing</span>
<span class="sd">        how the DataSet, Slice, SliceKey, and filenames are named in the chosen mode</span>
<span class="sd">        (&#39;entire&#39; or &#39;row-by-row&#39;).</span>

<span class="sd">    Algorithm:</span>
<span class="sd">        1) Extract numeric digits from &#39;orcid&#39; =&gt; numeric_orcid.</span>
<span class="sd">        2) Build the .txt filename =&gt; naming_conventions_{numeric_orcid}_{overall_timestamp}.txt.</span>
<span class="sd">        3) Depending on &#39;conversion_mode&#39;, build a descriptive message about naming patterns.</span>
<span class="sd">        4) Write this message to the .txt file in &#39;root_folder_path&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        root_folder_path (str): The folder where we store the .txt file.</span>
<span class="sd">        conversion_mode (str): &#39;entire&#39; or &#39;row-by-row&#39; mode.</span>
<span class="sd">        orcid (str): The user&#39;s ORCID (for numeric extraction).</span>
<span class="sd">        overall_timestamp (str): The run-specific timestamp used for naming outputs.</span>
<span class="sd">        dataset_name (str): The sanitized dataset name to reference in the doc.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">numeric_orcid</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span> <span class="n">orcid</span><span class="p">))</span>
    <span class="n">txt_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;naming_conventions_</span><span class="si">{</span><span class="n">numeric_orcid</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">overall_timestamp</span><span class="si">}</span><span class="s2">.txt&quot;</span>
    <span class="n">txt_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_folder_path</span><span class="p">,</span> <span class="n">txt_filename</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">conversion_mode</span> <span class="o">==</span> <span class="s2">&quot;entire&quot;</span><span class="p">:</span>
        <span class="c1"># Single qb:DataSet with multiple qb:Slices</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Naming Conventions for ENTIRE Dataset Mode</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;-----------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Root folder: Output_</span><span class="si">{</span><span class="n">numeric_orcid</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">overall_timestamp</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;We produce subfolders &#39;ttl&#39;, &#39;jsonld&#39;, &#39;hash&#39;.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Single qb:DataSet =&gt; mds:Dataset_</span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">numeric_orcid</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">overall_timestamp</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Single qb:SliceKey =&gt; mds:SliceKey_</span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">numeric_orcid</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">overall_timestamp</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Each row =&gt; qb:Slice =&gt; mds:Slice_</span><span class="si">{anyApprovedIDs}</span><span class="s2">_</span><span class="si">{orcidDigits}</span><span class="s2">_</span><span class="si">{timestamp}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Output filenames typically:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">numeric_orcid</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">overall_timestamp</span><span class="si">}</span><span class="s2">.ttl</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">numeric_orcid</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">overall_timestamp</span><span class="si">}</span><span class="s2">.jsonld</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">numeric_orcid</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">overall_timestamp</span><span class="si">}</span><span class="s2">.jsonld.sha256</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Where </span><span class="si">{anyApprovedIDs}</span><span class="s2"> are user-approved ID columns (e.g. &#39;ExperimentId&#39;).</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">conversion_mode</span> <span class="o">==</span> <span class="s2">&quot;row-by-row&quot;</span><span class="p">:</span>
        <span class="c1"># row-by-row mode =&gt; each row =&gt; separate DataSet</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Naming Conventions for ROW-BY-ROW Mode</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;--------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Root folder: Output_</span><span class="si">{</span><span class="n">numeric_orcid</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">overall_timestamp</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;We produce subfolders &#39;ttl&#39;, &#39;jsonld&#39;, &#39;hash&#39;.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Each row =&gt; separate qb:DataSet =&gt; mds:Dataset_</span><span class="si">{anyApprovedIDs}</span><span class="s2">_</span><span class="si">{orcidDigits}</span><span class="s2">_</span><span class="si">{timestamp}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;           plus a qb:Slice =&gt; mds:Slice_</span><span class="si">{anyApprovedIDs}</span><span class="s2">_</span><span class="si">{orcidDigits}</span><span class="s2">_</span><span class="si">{timestamp}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;           and a qb:SliceKey =&gt; mds:SliceKey_</span><span class="si">{anyApprovedIDs}</span><span class="s2">_</span><span class="si">{orcidDigits}</span><span class="s2">_</span><span class="si">{timestamp}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Output filenames per row:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;   </span><span class="si">{anyApprovedIDs}</span><span class="s2">_</span><span class="si">{orcidDigits}</span><span class="s2">_</span><span class="si">{timestamp}</span><span class="s2">.ttl</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;   </span><span class="si">{anyApprovedIDs}</span><span class="s2">_</span><span class="si">{orcidDigits}</span><span class="s2">_</span><span class="si">{timestamp}</span><span class="s2">.jsonld</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;   </span><span class="si">{anyApprovedIDs}</span><span class="s2">_</span><span class="si">{orcidDigits}</span><span class="s2">_</span><span class="si">{timestamp}</span><span class="s2">.jsonld.sha256</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Where </span><span class="si">{anyApprovedIDs}</span><span class="s2"> are user-approved ID columns, e.g. &#39;ExperimentId&#39;.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Naming Conventions for CRADLE Mode</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;--------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Root folder: Output_</span><span class="si">{</span><span class="n">numeric_orcid</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">overall_timestamp</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;We produce subfolders &#39;ttl&#39;, &#39;jsonld&#39;, &#39;hash&#39;.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Each row =&gt; separate qb:DataSet =&gt; mds:Dataset_</span><span class="si">{randomLetter}</span><span class="s2">_</span><span class="si">{enteredIDs}</span><span class="s2">_</span><span class="si">{anyApprovedIDs}</span><span class="s2">_</span><span class="si">{orcidDigits}</span><span class="s2">_</span><span class="si">{timestamp}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;           plus a qb:Slice =&gt; mds:Slice_</span><span class="si">{randomLetter}</span><span class="s2">_</span><span class="si">{enteredIDs}</span><span class="s2">_</span><span class="si">{anyApprovedIDs}</span><span class="s2">_</span><span class="si">{orcidDigits}</span><span class="s2">_</span><span class="si">{timestamp}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;           and a qb:SliceKey =&gt; mds:SliceKey_</span><span class="si">{randomLetter}</span><span class="s2">_</span><span class="si">{enteredIDs}</span><span class="s2">_</span><span class="si">{anyApprovedIDs}</span><span class="s2">_</span><span class="si">{orcidDigits}</span><span class="s2">_</span><span class="si">{timestamp}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Output filenames per row:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;   </span><span class="si">{randomLetter}</span><span class="s2">_</span><span class="si">{enteredIDs}</span><span class="s2">_</span><span class="si">{anyApprovedIDs}</span><span class="s2">_</span><span class="si">{orcidDigits}</span><span class="s2">_</span><span class="si">{timestamp}</span><span class="s2">.ttl</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;   </span><span class="si">{randomLetter}</span><span class="s2">_</span><span class="si">{enteredIDs}</span><span class="s2">_</span><span class="si">{anyApprovedIDs}</span><span class="s2">_</span><span class="si">{orcidDigits}</span><span class="s2">_</span><span class="si">{timestamp}</span><span class="s2">.jsonld</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;   </span><span class="si">{randomLetter}</span><span class="s2">_</span><span class="si">{enteredIDs}</span><span class="s2">_</span><span class="si">{anyApprovedIDs}</span><span class="s2">_</span><span class="si">{orcidDigits}</span><span class="s2">_</span><span class="si">{timestamp}</span><span class="s2">.jsonld.sha256</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Where </span><span class="si">{enteredIDs}</span><span class="s2"> are additional top level concept IDs and </span><span class="si">{anyApprovedIDs}</span><span class="s2"> are user-approved ID columns, e.g. &#39;ExperimentId&#39;.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">txt_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>



<span class="c1"># =============================================================================</span>
<span class="c1">#        HELPER: NAMESPACE PREPARATION</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="prepare_namespaces">
<a class="viewcode-back" href="../../../FAIRLinked.QBWorkflow.html#FAIRLinked.QBWorkflow.rdf_transformer.prepare_namespaces">[docs]</a>
<span class="k">def</span> <span class="nf">prepare_namespaces</span><span class="p">(</span><span class="n">namespace_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">user_chosen_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">DEFAULT_USER_PREFIX</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description:</span>
<span class="sd">        Validates the user-defined prefix in namespace_map, ensures each URI ends with</span>
<span class="sd">        &#39;/&#39; or &#39;#&#39;, and converts them to rdflib.Namespace objects.</span>

<span class="sd">    Algorithm:</span>
<span class="sd">        1) Copy the input namespace_map.</span>
<span class="sd">        2) Check if user_chosen_prefix in the map; raise an error if missing.</span>
<span class="sd">        3) For each (prefix, uri):</span>
<span class="sd">           - Validate it starts with http(s).</span>
<span class="sd">           - Ensure it ends with &#39;/&#39; or &#39;#&#39;.</span>
<span class="sd">        4) Convert each to Namespace(...).</span>
<span class="sd">        5) Return the new dictionary.</span>

<span class="sd">    Args:</span>
<span class="sd">        namespace_map (dict):</span>
<span class="sd">            Keys =&gt; prefix (str), Values =&gt; base URI (str).</span>
<span class="sd">        user_chosen_prefix (str):</span>
<span class="sd">            The prefix the user wants to use for new IRIs (default: &#39;mds&#39;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict:</span>
<span class="sd">            A mapping of prefix =&gt; rdflib.Namespace objects.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError if user_chosen_prefix is missing or if any URI is invalid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ns_map</span> <span class="o">=</span> <span class="n">namespace_map</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user_chosen_prefix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ns_map</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Namespace URI for prefix &#39;</span><span class="si">{</span><span class="n">user_chosen_prefix</span><span class="si">}</span><span class="s2">&#39; required.&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">uri</span> <span class="ow">in</span> <span class="n">ns_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^https?://&#39;</span><span class="p">,</span> <span class="n">uri</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid URI &#39;</span><span class="si">{</span><span class="n">uri</span><span class="si">}</span><span class="s2">&#39; for prefix &#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">uri</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">)):</span>
            <span class="n">ns_map</span><span class="p">[</span><span class="n">prefix</span><span class="p">]</span> <span class="o">=</span> <span class="n">uri</span> <span class="o">+</span> <span class="s1">&#39;#&#39;</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">prefix</span><span class="p">:</span> <span class="n">Namespace</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span> <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">uri</span> <span class="ow">in</span> <span class="n">ns_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span></div>



<span class="c1"># =============================================================================</span>
<span class="c1">#   SANITIZERS (IRIs vs Filenames)</span>
<span class="c1"># =============================================================================</span>

<span class="k">def</span> <span class="nf">_sanitize_for_iri</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description:</span>
<span class="sd">        Cleans up a string for use as an IRI local name by:</span>
<span class="sd">         - replacing all non-word chars with &#39;_&#39;</span>
<span class="sd">         - if it begins with a digit, prepend &#39;_&#39;</span>
<span class="sd">         - condensing multiple underscores to one</span>
<span class="sd">         - removing trailing underscores</span>

<span class="sd">    Algorithm:</span>
<span class="sd">        1) re.sub non-word =&gt; &#39;_&#39;</span>
<span class="sd">        2) if it starts with a digit =&gt; prepend &#39;_&#39;</span>
<span class="sd">        3) re.sub multiple =&gt; single underscore</span>
<span class="sd">        4) strip trailing underscores</span>

<span class="sd">    Args:</span>
<span class="sd">        s (str): The raw string needing sanitization.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: A cleaned version suitable for IRIs, e.g. &quot;Detector_1&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^\w]+&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\d&#39;</span><span class="p">,</span> <span class="n">cleaned</span><span class="p">):</span>
        <span class="n">cleaned</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">cleaned</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;__+&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">cleaned</span><span class="p">)</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="n">cleaned</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cleaned</span>


<span class="k">def</span> <span class="nf">_sanitize_for_filename</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description:</span>
<span class="sd">        Cleans up a string for filenames by replacing non-word chars =&gt; &#39;_&#39; and not forcibly</span>
<span class="sd">        prepending underscores if it starts with a digit. Also condenses multiple underscores</span>
<span class="sd">        and strips trailing underscores.</span>

<span class="sd">    Algorithm:</span>
<span class="sd">        1) re.sub non-word =&gt; &#39;_&#39;</span>
<span class="sd">        2) re.sub multiple =&gt; single underscore</span>
<span class="sd">        3) strip trailing underscores</span>

<span class="sd">    Args:</span>
<span class="sd">        s (str): The raw string.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: A cleaned version more suitable for filenames, e.g. &quot;Detector_1&quot; or &quot;3_14&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^\w]+&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;__+&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">cleaned</span><span class="p">)</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="n">cleaned</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cleaned</span>


<span class="c1"># =============================================================================</span>
<span class="c1">#  UTILS</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="get_property_uri">
<a class="viewcode-back" href="../../../FAIRLinked.QBWorkflow.html#FAIRLinked.QBWorkflow.rdf_transformer.get_property_uri">[docs]</a>
<span class="k">def</span> <span class="nf">get_property_uri</span><span class="p">(</span><span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">meta</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">ns_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">user_ns</span><span class="p">:</span> <span class="n">Namespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">URIRef</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description:</span>
<span class="sd">        Obtains the appropriate URIRef for a given variable. If &#39;ExistingURI&#39; is provided,</span>
<span class="sd">        attempts to parse it as &#39;prefix:LocalPart&#39; or a full URI. Otherwise, uses the user</span>
<span class="sd">        namespace + sanitized var_name.</span>

<span class="sd">    Algorithm:</span>
<span class="sd">        1) If meta has &#39;ExistingURI&#39;:</span>
<span class="sd">           a) if it has &#39;:&#39; =&gt; split prefix vs. local_part</span>
<span class="sd">              =&gt; look up in ns_map =&gt; create ns[local_part]</span>
<span class="sd">           b) else treat it as a full URIRef</span>
<span class="sd">        2) Otherwise =&gt; user_ns[var_name], with spaces replaced by underscores.</span>

<span class="sd">    Args:</span>
<span class="sd">        var_name (str): The DataFrame column name.</span>
<span class="sd">        meta (dict): The metadata for that variable (keys e.g. &#39;ExistingURI&#39;).</span>
<span class="sd">        ns_map (dict): A dictionary mapping prefix =&gt; rdflib.Namespace.</span>
<span class="sd">        user_ns (Namespace): The user-chosen prefix&#39;s Namespace object.</span>

<span class="sd">    Returns:</span>
<span class="sd">        rdflib.term.URIRef: The final property URI for this variable.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError if prefix not found in ns_map.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">existing_uri</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">EXISTING_URI_FIELD</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">existing_uri</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">existing_uri</span><span class="p">:</span>
            <span class="n">prefix</span><span class="p">,</span> <span class="n">local_part</span> <span class="o">=</span> <span class="n">existing_uri</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="n">ns_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ns</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Prefix &#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&#39; not found for ExistingURI &#39;</span><span class="si">{</span><span class="n">existing_uri</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ns</span><span class="p">[</span><span class="n">local_part</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># treat as a full URI</span>
            <span class="k">return</span> <span class="n">URIRef</span><span class="p">(</span><span class="n">existing_uri</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sanitized_var_name</span> <span class="o">=</span> <span class="n">var_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user_ns</span><span class="p">[</span><span class="n">sanitized_var_name</span><span class="p">]</span></div>



<div class="viewcode-block" id="extract_variables">
<a class="viewcode-back" href="../../../FAIRLinked.QBWorkflow.html#FAIRLinked.QBWorkflow.rdf_transformer.extract_variables">[docs]</a>
<span class="k">def</span> <span class="nf">extract_variables</span><span class="p">(</span><span class="n">variable_metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">df_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description:</span>
<span class="sd">        Splits columns into &#39;dimensions&#39; or &#39;measures&#39; by checking variable_metadata[var_name][&#39;IsMeasure&#39;].</span>

<span class="sd">    Algorithm:</span>
<span class="sd">        1) Initialize dimensions = [] and measures = [].</span>
<span class="sd">        2) For each column in df_columns:</span>
<span class="sd">           - Retrieve meta = variable_metadata.get(column).</span>
<span class="sd">           - If meta is found, check &#39;IsMeasure&#39; =&gt; &#39;yes&#39;? =&gt; measures, else =&gt; dimensions.</span>
<span class="sd">           - If not found, log a warning message.</span>
<span class="sd">        3) Return (dimensions, measures).</span>

<span class="sd">    Args:</span>
<span class="sd">        variable_metadata (dict): A dict mapping column =&gt; metadata (with &#39;IsMeasure&#39;, etc.).</span>
<span class="sd">        df_columns (list): The list of column names from the DataFrame.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (list, list):</span>
<span class="sd">            A tuple of (dimensions, measures).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dimensions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">measures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">df_columns</span><span class="p">:</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">variable_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">meta</span><span class="p">:</span>
            <span class="n">is_measure_value</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">IS_MEASURE_FIELD</span><span class="p">)</span>
            <span class="n">is_measure</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">is_measure_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> 
                <span class="n">is_measure_value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">is_measure</span><span class="p">:</span>
                <span class="n">measures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dimensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ERROR_MSG_VARIABLE_NOT_FOUND</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="n">var_name</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dimensions</span><span class="p">,</span> <span class="n">measures</span></div>



<div class="viewcode-block" id="process_unit">
<a class="viewcode-back" href="../../../FAIRLinked.QBWorkflow.html#FAIRLinked.QBWorkflow.rdf_transformer.process_unit">[docs]</a>
<span class="k">def</span> <span class="nf">process_unit</span><span class="p">(</span><span class="n">unit_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ns_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">user_ns</span><span class="p">:</span> <span class="n">Namespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">URIRef</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description:</span>
<span class="sd">        Interprets a &#39;Unit&#39; string from variable_metadata and returns an rdflib.URIRef</span>
<span class="sd">        for that unit. If it&#39;s &#39;prefix:LocalPart&#39;, we look up prefix in ns_map. Otherwise,</span>
<span class="sd">        we treat it as user_ns[unitStr] (with spaces replaced).</span>

<span class="sd">    Algorithm:</span>
<span class="sd">        1) If unit_str is empty =&gt; return None.</span>
<span class="sd">        2) If &#39;:&#39; in unit_str =&gt; parse prefix, local_part =&gt; ns_map[prefix][local_part].</span>
<span class="sd">        3) Otherwise =&gt; user_ns[unit_str], replacing spaces with underscores.</span>
<span class="sd">        4) If prefix not found =&gt; raise ValueError.</span>

<span class="sd">    Args:</span>
<span class="sd">        unit_str (str): e.g. &quot;qudt:MilliM&quot; or &quot;MyLocalUnit&quot;.</span>
<span class="sd">        ns_map (dict): prefix =&gt; Namespace</span>
<span class="sd">        user_ns (Namespace): the user prefix&#39;s namespace.</span>

<span class="sd">    Returns:</span>
<span class="sd">        rdflib.URIRef or None if no unit_str given.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError if prefix is missing from ns_map.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">unit_str</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">unit_str</span><span class="p">:</span>
            <span class="n">prefix</span><span class="p">,</span> <span class="n">local_part</span> <span class="o">=</span> <span class="n">unit_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">unit_ns</span> <span class="o">=</span> <span class="n">ns_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">unit_ns</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">ERROR_MSG_PREFIX_NOT_FOUND</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">unit_str</span><span class="o">=</span><span class="n">unit_str</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">unit_ns</span><span class="p">[</span><span class="n">local_part</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">user_ns</span><span class="p">[</span><span class="n">unit_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing unit &#39;</span><span class="si">{</span><span class="n">unit_str</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>

    
<span class="k">def</span> <span class="nf">_create_id_string</span><span class="p">(</span><span class="n">id_dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to turn user-entered IDs into a string for CRADLE naming</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">id_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">id_dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">id_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">id_string</span> <span class="o">+=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">id_string</span>


<span class="c1"># =============================================================================</span>
<span class="c1">#        BUILDING THE RDF DATA CUBE: DSD &amp; Observations</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="add_component_to_dsd">
<a class="viewcode-back" href="../../../FAIRLinked.QBWorkflow.html#FAIRLinked.QBWorkflow.rdf_transformer.add_component_to_dsd">[docs]</a>
<span class="k">def</span> <span class="nf">add_component_to_dsd</span><span class="p">(</span><span class="n">dsd_graph</span><span class="p">:</span> <span class="n">Graph</span><span class="p">,</span>
                         <span class="n">dsd_uri</span><span class="p">:</span> <span class="n">URIRef</span><span class="p">,</span>
                         <span class="n">prop_uri</span><span class="p">:</span> <span class="n">URIRef</span><span class="p">,</span>
                         <span class="n">component_type</span><span class="p">:</span> <span class="n">URIRef</span><span class="p">,</span>
                         <span class="n">prop_type</span><span class="p">:</span> <span class="n">URIRef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description:</span>
<span class="sd">        Adds a dimension/measure/attribute property to the qb:DataStructureDefinition</span>
<span class="sd">        by creating a blank node and linking it accordingly.</span>

<span class="sd">    Algorithm:</span>
<span class="sd">        1) Create a blank node =&gt; component.</span>
<span class="sd">        2) dsd_uri -- qb:component --&gt; component</span>
<span class="sd">        3) component -- (component_type) --&gt; prop_uri  (e.g. dimension =&gt; prop_uri)</span>
<span class="sd">        4) prop_uri -- rdf:type --&gt; prop_type</span>

<span class="sd">    Args:</span>
<span class="sd">        dsd_graph (Graph): The Graph that holds the DSD.</span>
<span class="sd">        dsd_uri (URIRef): The DataStructureDefinition node.</span>
<span class="sd">        prop_uri (URIRef): The property URI for this dimension/measure/attribute.</span>
<span class="sd">        component_type (URIRef): e.g. qb:dimension, qb:measure, qb:attribute.</span>
<span class="sd">        prop_type (URIRef): e.g. qb:DimensionProperty, qb:MeasureProperty, qb:AttributeProperty.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">component</span> <span class="o">=</span> <span class="n">BNode</span><span class="p">()</span>
    <span class="n">dsd_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">dsd_uri</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">component</span><span class="p">,</span> <span class="n">component</span><span class="p">))</span>
    <span class="n">dsd_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">component</span><span class="p">,</span> <span class="n">component_type</span><span class="p">,</span> <span class="n">prop_uri</span><span class="p">))</span>
    <span class="n">dsd_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">prop_uri</span><span class="p">,</span> <span class="n">RDF</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">prop_type</span><span class="p">))</span></div>



<div class="viewcode-block" id="create_dsd">
<a class="viewcode-back" href="../../../FAIRLinked.QBWorkflow.html#FAIRLinked.QBWorkflow.rdf_transformer.create_dsd">[docs]</a>
<span class="k">def</span> <span class="nf">create_dsd</span><span class="p">(</span><span class="n">variable_metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
               <span class="n">dimensions</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
               <span class="n">measures</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
               <span class="n">ns_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
               <span class="n">user_ns</span><span class="p">:</span> <span class="n">Namespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description:</span>
<span class="sd">        Builds a qb:DataStructureDefinition for the given dimensions and measures.</span>
<span class="sd">        Also sets up measureType as a dimension. Adds optional qb:attribute for &#39;unitMeasure&#39;</span>
<span class="sd">        and &#39;category&#39; if present.</span>

<span class="sd">    Algorithm:</span>
<span class="sd">        1) Initialize an empty Graph, bind namespace prefixes.</span>
<span class="sd">        2) Create dsd_uri = user_ns[&quot;DataStructureDefinition&quot;], mark it as qb:DataStructureDefinition.</span>
<span class="sd">        3) For each dimension =&gt; add_component_to_dsd(...).</span>
<span class="sd">        4) Add measureType as dimension.</span>
<span class="sd">        5) For each measure =&gt; add_component_to_dsd(...).</span>
<span class="sd">        6) If any columns require &#39;unitMeasure&#39; or &#39;category&#39;, add qb:attribute.</span>
<span class="sd">        7) Return (dsd_graph, dsd_uri).</span>

<span class="sd">    Args:</span>
<span class="sd">        variable_metadata (dict): Maps column =&gt; metadata (like AltLabel, Category, etc.).</span>
<span class="sd">        dimensions (list): The dimension column names.</span>
<span class="sd">        measures (list): The measure column names.</span>
<span class="sd">        ns_map (dict): prefix =&gt; Namespace</span>
<span class="sd">        user_ns (Namespace): The user-chosen prefix&#39;s Namespace.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (Graph, URIRef):</span>
<span class="sd">            dsd_graph: The Graph containing the DSD definitions.</span>
<span class="sd">            dsd_uri: The URIRef for the qb:DataStructureDefinition.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dsd_graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">ns_obj</span> <span class="ow">in</span> <span class="n">ns_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">dsd_graph</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">ns_obj</span><span class="p">)</span>
    <span class="n">dsd_graph</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;skos&#39;</span><span class="p">,</span> <span class="n">SKOS</span><span class="p">)</span>

    <span class="n">dsd_uri</span> <span class="o">=</span> <span class="n">user_ns</span><span class="p">[</span><span class="s2">&quot;DataStructureDefinition&quot;</span><span class="p">]</span>
    <span class="n">dsd_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">dsd_uri</span><span class="p">,</span> <span class="n">RDF</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">DataStructureDefinition</span><span class="p">))</span>

    <span class="c1"># 1) Dimensions (excluding measureType)</span>
    <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">dimensions</span><span class="p">:</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">variable_metadata</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
        <span class="n">dim_prop</span> <span class="o">=</span> <span class="n">get_property_uri</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">ns_map</span><span class="p">,</span> <span class="n">user_ns</span><span class="p">)</span>
        <span class="n">add_component_to_dsd</span><span class="p">(</span><span class="n">dsd_graph</span><span class="p">,</span> <span class="n">dsd_uri</span><span class="p">,</span> <span class="n">dim_prop</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">dimension</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">DimensionProperty</span><span class="p">)</span>

        <span class="n">alt_label</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AltLabel&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">alt_label</span><span class="p">:</span>
            <span class="n">dsd_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">dim_prop</span><span class="p">,</span> <span class="n">SKOS</span><span class="o">.</span><span class="n">altLabel</span><span class="p">,</span> <span class="n">Literal</span><span class="p">(</span><span class="n">alt_label</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">CATEGORY_FIELD</span> <span class="ow">in</span> <span class="n">meta</span> <span class="ow">and</span> <span class="n">meta</span><span class="p">[</span><span class="n">CATEGORY_FIELD</span><span class="p">]:</span>
            <span class="n">cat_prop</span> <span class="o">=</span> <span class="n">user_ns</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span>
            <span class="n">cat_uri</span> <span class="o">=</span> <span class="n">user_ns</span><span class="p">[</span><span class="n">meta</span><span class="p">[</span><span class="n">CATEGORY_FIELD</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)]</span>
            <span class="n">dsd_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">dim_prop</span><span class="p">,</span> <span class="n">cat_prop</span><span class="p">,</span> <span class="n">cat_uri</span><span class="p">))</span>

    <span class="c1"># measureType dimension</span>
    <span class="n">add_component_to_dsd</span><span class="p">(</span><span class="n">dsd_graph</span><span class="p">,</span> <span class="n">dsd_uri</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">measureType</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">dimension</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">DimensionProperty</span><span class="p">)</span>

    <span class="c1"># 2) Measures</span>
    <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">measures</span><span class="p">:</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">variable_metadata</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
        <span class="n">meas_prop</span> <span class="o">=</span> <span class="n">get_property_uri</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">ns_map</span><span class="p">,</span> <span class="n">user_ns</span><span class="p">)</span>
        <span class="n">add_component_to_dsd</span><span class="p">(</span><span class="n">dsd_graph</span><span class="p">,</span> <span class="n">dsd_uri</span><span class="p">,</span> <span class="n">meas_prop</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">measure</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">MeasureProperty</span><span class="p">)</span>

        <span class="n">alt_label</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AltLabel&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">alt_label</span><span class="p">:</span>
            <span class="n">dsd_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">meas_prop</span><span class="p">,</span> <span class="n">SKOS</span><span class="o">.</span><span class="n">altLabel</span><span class="p">,</span> <span class="n">Literal</span><span class="p">(</span><span class="n">alt_label</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">CATEGORY_FIELD</span> <span class="ow">in</span> <span class="n">meta</span> <span class="ow">and</span> <span class="n">meta</span><span class="p">[</span><span class="n">CATEGORY_FIELD</span><span class="p">]:</span>
            <span class="n">cat_prop</span> <span class="o">=</span> <span class="n">user_ns</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span>
            <span class="n">cat_uri</span> <span class="o">=</span> <span class="n">user_ns</span><span class="p">[</span><span class="n">meta</span><span class="p">[</span><span class="n">CATEGORY_FIELD</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)]</span>
            <span class="n">dsd_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">meas_prop</span><span class="p">,</span> <span class="n">cat_prop</span><span class="p">,</span> <span class="n">cat_uri</span><span class="p">))</span>

    <span class="c1"># 3) Check if we need qb:attribute for &#39;unitMeasure&#39; or &#39;category&#39;</span>
    <span class="n">attributes_used</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">meta</span> <span class="ow">in</span> <span class="n">variable_metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">UNIT_FIELD</span> <span class="ow">in</span> <span class="n">meta</span> <span class="ow">and</span> <span class="n">meta</span><span class="p">[</span><span class="n">UNIT_FIELD</span><span class="p">]:</span>
            <span class="n">attributes_used</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;unitMeasure&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">CATEGORY_FIELD</span> <span class="ow">in</span> <span class="n">meta</span> <span class="ow">and</span> <span class="n">meta</span><span class="p">[</span><span class="n">CATEGORY_FIELD</span><span class="p">]:</span>
            <span class="n">attributes_used</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>

    <span class="n">sdmx_attr</span> <span class="o">=</span> <span class="n">ns_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sdmx-attribute&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;unitMeasure&#39;</span> <span class="ow">in</span> <span class="n">attributes_used</span> <span class="ow">and</span> <span class="n">sdmx_attr</span><span class="p">:</span>
        <span class="n">unit_meas</span> <span class="o">=</span> <span class="n">sdmx_attr</span><span class="p">[</span><span class="s1">&#39;unitMeasure&#39;</span><span class="p">]</span>
        <span class="n">add_component_to_dsd</span><span class="p">(</span><span class="n">dsd_graph</span><span class="p">,</span> <span class="n">dsd_uri</span><span class="p">,</span> <span class="n">unit_meas</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">attribute</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">AttributeProperty</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s1">&#39;unitMeasure&#39;</span> <span class="ow">in</span> <span class="n">attributes_used</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sdmx_attr</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: &#39;sdmx-attribute&#39; not found. Skipping unitMeasure attribute.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;category&#39;</span> <span class="ow">in</span> <span class="n">attributes_used</span><span class="p">:</span>
        <span class="n">cat_prop</span> <span class="o">=</span> <span class="n">user_ns</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span>
        <span class="n">add_component_to_dsd</span><span class="p">(</span><span class="n">dsd_graph</span><span class="p">,</span> <span class="n">dsd_uri</span><span class="p">,</span> <span class="n">cat_prop</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">attribute</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">AttributeProperty</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dsd_graph</span><span class="p">,</span> <span class="n">dsd_uri</span></div>



<div class="viewcode-block" id="create_observation">
<a class="viewcode-back" href="../../../FAIRLinked.QBWorkflow.html#FAIRLinked.QBWorkflow.rdf_transformer.create_observation">[docs]</a>
<span class="k">def</span> <span class="nf">create_observation</span><span class="p">(</span><span class="n">dataset_graph</span><span class="p">:</span> <span class="n">Graph</span><span class="p">,</span>
                       <span class="n">row</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                       <span class="n">variable_metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                       <span class="n">variable_dimensions</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                       <span class="n">measures</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                       <span class="n">ns_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                       <span class="n">user_ns</span><span class="p">:</span> <span class="n">Namespace</span><span class="p">,</span>
                       <span class="n">observation_counter</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description:</span>
<span class="sd">        For each measure in &#39;measures&#39;, if the row has a non-null value, create a qb:Observation</span>
<span class="sd">        node. Link measureType =&gt; measure property, store measure value, dimension values (from</span>
<span class="sd">        variable_dimensions), and optionally link the unit measure if found.</span>

<span class="sd">    Algorithm:</span>
<span class="sd">        1) For each measure in &#39;measures&#39;:</span>
<span class="sd">           a) If row[measure] is not null =&gt; create observation_{observation_counter} as qb:Observation.</span>
<span class="sd">           b) Add triple (obs_uri, qb:measureType, measure_prop).</span>
<span class="sd">           c) Add triple (obs_uri, measure_prop, measure_value).</span>
<span class="sd">           d) For each dimension in variable_dimensions =&gt; store dimension_value or NotFound.</span>
<span class="sd">           e) If UNIT_FIELD =&gt; link sdmx-attribute:unitMeasure =&gt; unit URI.</span>
<span class="sd">        2) Return (list_of_observation_uris, updated_observation_counter).</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset_graph (Graph): The graph where we store Observations and data.</span>
<span class="sd">        row (pd.Series): A single row from the DataFrame.</span>
<span class="sd">        variable_metadata (dict): column =&gt; metadata.</span>
<span class="sd">        variable_dimensions (list): the subset of dimensions that vary in this context.</span>
<span class="sd">        measures (list): measure column names.</span>
<span class="sd">        ns_map (dict): prefix =&gt; Namespace.</span>
<span class="sd">        user_ns (Namespace): the user-chosen prefix&#39;s Namespace object.</span>
<span class="sd">        observation_counter (int): the current global counter for numbering Observations.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (list_of_obs_uris, updated_counter):</span>
<span class="sd">            A list of the newly created observation URIs, plus the incremented observation_counter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sdmx_attr</span> <span class="o">=</span> <span class="n">ns_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sdmx-attribute&#39;</span><span class="p">)</span>
    <span class="n">not_found_uri</span> <span class="o">=</span> <span class="n">user_ns</span><span class="p">[</span><span class="s1">&#39;NotFound&#39;</span><span class="p">]</span>

    <span class="n">observations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">measure_name</span> <span class="ow">in</span> <span class="n">measures</span><span class="p">:</span>
        <span class="n">measure_value</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">measure_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">measure_value</span><span class="p">):</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">variable_metadata</span><span class="p">[</span><span class="n">measure_name</span><span class="p">]</span>
            <span class="n">measure_prop</span> <span class="o">=</span> <span class="n">get_property_uri</span><span class="p">(</span><span class="n">measure_name</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">ns_map</span><span class="p">,</span> <span class="n">user_ns</span><span class="p">)</span>
            <span class="n">obs_uri</span> <span class="o">=</span> <span class="n">user_ns</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;observation_</span><span class="si">{</span><span class="n">observation_counter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="n">observation_counter</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">dataset_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">obs_uri</span><span class="p">,</span> <span class="n">RDF</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">Observation</span><span class="p">))</span>
            <span class="n">dataset_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">obs_uri</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">measureType</span><span class="p">,</span> <span class="n">measure_prop</span><span class="p">))</span>

            <span class="c1"># measure value</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val_literal</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">measure_value</span><span class="p">),</span> <span class="n">datatype</span><span class="o">=</span><span class="n">XSD</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="n">val_literal</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">(</span><span class="n">measure_value</span><span class="p">)</span>
            <span class="n">dataset_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">obs_uri</span><span class="p">,</span> <span class="n">measure_prop</span><span class="p">,</span> <span class="n">val_literal</span><span class="p">))</span>

            <span class="c1"># dimension values</span>
            <span class="k">for</span> <span class="n">dim_name</span> <span class="ow">in</span> <span class="n">variable_dimensions</span><span class="p">:</span>
                <span class="n">dim_val</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dim_name</span><span class="p">)</span>
                <span class="n">dim_meta</span> <span class="o">=</span> <span class="n">variable_metadata</span><span class="p">[</span><span class="n">dim_name</span><span class="p">]</span>
                <span class="n">dim_prop</span> <span class="o">=</span> <span class="n">get_property_uri</span><span class="p">(</span><span class="n">dim_name</span><span class="p">,</span> <span class="n">dim_meta</span><span class="p">,</span> <span class="n">ns_map</span><span class="p">,</span> <span class="n">user_ns</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">dim_val</span><span class="p">):</span>
                    <span class="n">dataset_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">obs_uri</span><span class="p">,</span> <span class="n">dim_prop</span><span class="p">,</span> <span class="n">Literal</span><span class="p">(</span><span class="n">dim_val</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dataset_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">obs_uri</span><span class="p">,</span> <span class="n">dim_prop</span><span class="p">,</span> <span class="n">not_found_uri</span><span class="p">))</span>

            <span class="c1"># unit measure</span>
            <span class="n">unit_uri</span> <span class="o">=</span> <span class="n">process_unit</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">UNIT_FIELD</span><span class="p">),</span> <span class="n">ns_map</span><span class="p">,</span> <span class="n">user_ns</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">unit_uri</span> <span class="ow">and</span> <span class="n">sdmx_attr</span><span class="p">:</span>
                <span class="n">dataset_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">obs_uri</span><span class="p">,</span> <span class="n">sdmx_attr</span><span class="p">[</span><span class="s1">&#39;unitMeasure&#39;</span><span class="p">],</span> <span class="n">unit_uri</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">unit_uri</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sdmx_attr</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: &#39;sdmx-attribute&#39; missing. Skipping unitMeasure attribute.&quot;</span><span class="p">)</span>

            <span class="n">observations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs_uri</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">observations</span><span class="p">,</span> <span class="n">observation_counter</span></div>



<div class="viewcode-block" id="create_observation_2">
<a class="viewcode-back" href="../../../FAIRLinked.QBWorkflow.html#FAIRLinked.QBWorkflow.rdf_transformer.create_observation_2">[docs]</a>
<span class="k">def</span> <span class="nf">create_observation_2</span><span class="p">(</span><span class="n">row</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                       <span class="n">variable_metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                       <span class="n">ns_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                       <span class="n">user_ns</span><span class="p">:</span> <span class="n">Namespace</span><span class="p">,</span>
                       <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Graph</span><span class="p">:</span>

    <span class="n">row_graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">(</span><span class="n">identifier</span><span class="o">=</span><span class="n">user_ns</span><span class="p">[</span><span class="n">file_name</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="n">ns_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">row_graph</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>

    <span class="n">MDS</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span><span class="s2">&quot;https://cwrusdle.bitbucket.io/mds#&quot;</span><span class="p">)</span>
    <span class="n">QUDT</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span><span class="s2">&quot;http://qudt.org/schema/qudt/&quot;</span><span class="p">)</span>
    <span class="n">UNIT</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span><span class="s2">&quot;http://qudt.org/vocab/unit/&quot;</span><span class="p">)</span>
    <span class="n">QK</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span><span class="s2">&quot;http://qudt.org/vocab/quantitykind/&quot;</span><span class="p">)</span>
    <span class="n">PROV</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span><span class="s2">&quot;http://www.w3.org/ns/prov#&quot;</span><span class="p">)</span>
    <span class="n">SKOS</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span><span class="s2">&quot;http://www.w3.org/2004/02/skos/core#&quot;</span><span class="p">)</span>

    <span class="n">row_graph</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;mds&quot;</span><span class="p">,</span> <span class="n">MDS</span><span class="p">)</span>
    <span class="n">row_graph</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;qudt&quot;</span><span class="p">,</span> <span class="n">QUDT</span><span class="p">)</span>
    <span class="n">row_graph</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;unit&quot;</span><span class="p">,</span> <span class="n">UNIT</span><span class="p">)</span>
    <span class="n">row_graph</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;quantitykind&quot;</span><span class="p">,</span> <span class="n">QK</span><span class="p">)</span>
    <span class="n">row_graph</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;prov&quot;</span><span class="p">,</span> <span class="n">PROV</span><span class="p">)</span>
    <span class="n">row_graph</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;skos&quot;</span><span class="p">,</span> <span class="n">SKOS</span><span class="p">)</span>    

    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">metadata</span> <span class="ow">in</span> <span class="n">variable_metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">unit_uri</span> <span class="o">=</span> <span class="n">process_unit</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">UNIT_FIELD</span><span class="p">),</span> <span class="n">ns_map</span><span class="p">,</span> <span class="n">user_ns</span><span class="p">)</span>
        <span class="n">var_uri</span> <span class="o">=</span> <span class="n">get_property_uri</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">ns_map</span><span class="p">,</span> <span class="n">user_ns</span><span class="p">)</span>
        <span class="n">var_instance_uri</span> <span class="o">=</span> <span class="n">URIRef</span><span class="p">(</span><span class="n">var_uri</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span>  <span class="n">file_name</span><span class="p">)</span>
        <span class="n">var_val</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="n">var_cat</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">CATEGORY_FIELD</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">var_val</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">unit_uri</span><span class="p">):</span>
                <span class="n">row_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">var_instance_uri</span><span class="p">,</span> <span class="n">RDF</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">var_uri</span><span class="p">))</span>
                <span class="n">row_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">var_instance_uri</span><span class="p">,</span> <span class="n">QUDT</span><span class="o">.</span><span class="n">hasUnit</span><span class="p">,</span> <span class="n">unit_uri</span><span class="p">))</span>
                <span class="n">row_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">var_instance_uri</span><span class="p">,</span> <span class="n">QUDT</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">Literal</span><span class="p">(</span><span class="n">var_val</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">XSD</span><span class="o">.</span><span class="n">float</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">row_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">var_instance_uri</span><span class="p">,</span> <span class="n">RDF</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">var_uri</span><span class="p">))</span>
                <span class="n">row_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">var_instance_uri</span><span class="p">,</span> <span class="n">QUDT</span><span class="o">.</span><span class="n">hasUnit</span><span class="p">,</span> <span class="n">BNode</span><span class="p">()))</span>
                <span class="n">row_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">var_instance_uri</span><span class="p">,</span> <span class="n">QUDT</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">Literal</span><span class="p">(</span><span class="n">var_val</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">XSD</span><span class="o">.</span><span class="n">string</span><span class="p">)))</span>


    <span class="k">return</span> <span class="n">row_graph</span></div>


        



<span class="c1"># =============================================================================</span>
<span class="c1">#          ROW-BY-ROW CONVERSION</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="convert_row_by_row">
<a class="viewcode-back" href="../../../FAIRLinked.QBWorkflow.html#FAIRLinked.QBWorkflow.rdf_transformer.convert_row_by_row">[docs]</a>
<span class="k">def</span> <span class="nf">convert_row_by_row</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">variable_metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">ns_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">user_chosen_prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">orcid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">root_folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">overall_timestamp</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description:</span>
<span class="sd">        Converts each row of a DataFrame into its own qb:DataSet in RDF, prompting the user</span>
<span class="sd">        to choose which ID columns to incorporate in naming. Each row-based dataset shares</span>
<span class="sd">        the same folder timestamp to keep them grouped.</span>

<span class="sd">    Algorithm:</span>
<span class="sd">        1) Identify candidate ID columns (contain &#39;id&#39;), pass &#39;row-by-row&#39; to get_approved_id_columns(...).</span>
<span class="sd">        2) Extract which columns are dimensions vs. measures =&gt; create a single DSD for entire DF.</span>
<span class="sd">        3) For each row =&gt; build a new Graph that:</span>
<span class="sd">            - Copies the DSD</span>
<span class="sd">            - Creates a new qb:DataSet =&gt; mds:Dataset_{someIDs}_{orcid}_{timestamp}</span>
<span class="sd">            - Creates a SliceKey =&gt; mds:SliceKey_{someIDs}_{orcid}_{timestamp}</span>
<span class="sd">            - Creates a Slice =&gt; mds:Slice_{someIDs}_{orcid}_{timestamp}</span>
<span class="sd">            - Adds Observations for each measure</span>
<span class="sd">        4) Write each row&#39;s TTL/JSON-LD + .sha256 hash in subfolders.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (pd.DataFrame): The entire DataFrame to convert row-by-row.</span>
<span class="sd">        variable_metadata (dict): column =&gt; metadata dictionary.</span>
<span class="sd">        ns_map (dict): prefix =&gt; Namespace mapping.</span>
<span class="sd">        user_chosen_prefix (str): e.g. &#39;mds&#39;.</span>
<span class="sd">        orcid (str): The user&#39;s ORCID, from which we extract digits.</span>
<span class="sd">        root_folder_path (str): The top-level folder for outputs.</span>
<span class="sd">        overall_timestamp (str): The run&#39;s global timestamp for consistent naming.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user_ns</span> <span class="o">=</span> <span class="n">ns_map</span><span class="p">[</span><span class="n">user_chosen_prefix</span><span class="p">]</span>

    <span class="n">candidate_id_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)]</span>
    <span class="n">approved_id_cols</span> <span class="o">=</span> <span class="n">get_approved_id_columns</span><span class="p">(</span><span class="n">candidate_id_cols</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;row-by-row&#39;</span><span class="p">)</span>

    <span class="c1"># Build a single DSD for entire DF</span>
    <span class="n">dimensions</span><span class="p">,</span> <span class="n">measures</span> <span class="o">=</span> <span class="n">extract_variables</span><span class="p">(</span><span class="n">variable_metadata</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">EXPERIMENT_ID_COLUMN</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">EXPERIMENT_ID_COLUMN</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dimensions</span><span class="p">:</span>
        <span class="n">dimensions</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">EXPERIMENT_ID_COLUMN</span><span class="p">)</span>

    <span class="n">dsd_graph</span><span class="p">,</span> <span class="n">dsd_uri</span> <span class="o">=</span> <span class="n">create_dsd</span><span class="p">(</span><span class="n">variable_metadata</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">,</span> <span class="n">measures</span><span class="p">,</span> <span class="n">ns_map</span><span class="p">,</span> <span class="n">user_ns</span><span class="p">)</span>

    <span class="c1"># For each row =&gt; new dataset</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="c1"># naming: from approved ID columns</span>
        <span class="n">name_parts_file</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">name_parts_iri</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">approved_id_cols</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">])</span> <span class="k">else</span> <span class="s2">&quot;NotFound&quot;</span>
            <span class="n">name_parts_file</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_sanitize_for_filename</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
            <span class="n">name_parts_iri</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_sanitize_for_iri</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>

        <span class="n">numeric_orcid</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span> <span class="n">orcid</span><span class="p">))</span>

        <span class="c1"># fallback =&gt; orcid + timestamp</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">name_parts_file</span><span class="p">):</span>
            <span class="n">combined_file</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name_parts_file</span> <span class="o">+</span> <span class="p">[</span><span class="n">numeric_orcid</span><span class="p">,</span> <span class="n">overall_timestamp</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">combined_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">numeric_orcid</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">overall_timestamp</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">combined_file</span> <span class="o">=</span> <span class="n">_sanitize_for_filename</span><span class="p">(</span><span class="n">combined_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">name_parts_iri</span><span class="p">):</span>
            <span class="n">combined_iri</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name_parts_iri</span> <span class="o">+</span> <span class="p">[</span><span class="n">numeric_orcid</span><span class="p">,</span> <span class="n">overall_timestamp</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">combined_iri</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">numeric_orcid</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">overall_timestamp</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">combined_iri</span> <span class="o">=</span> <span class="n">_sanitize_for_iri</span><span class="p">(</span><span class="n">combined_iri</span><span class="p">)</span>

        <span class="n">dataset_id_str</span> <span class="o">=</span> <span class="n">_sanitize_for_iri</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset_</span><span class="si">{</span><span class="n">combined_iri</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">slice_id_str</span> <span class="o">=</span> <span class="n">_sanitize_for_iri</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Slice_</span><span class="si">{</span><span class="n">combined_iri</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">slice_key_id</span> <span class="o">=</span> <span class="n">_sanitize_for_iri</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SliceKey_</span><span class="si">{</span><span class="n">combined_iri</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">dataset_uri</span> <span class="o">=</span> <span class="n">user_ns</span><span class="p">[</span><span class="n">dataset_id_str</span><span class="p">]</span>
        <span class="n">slice_uri</span> <span class="o">=</span> <span class="n">user_ns</span><span class="p">[</span><span class="n">slice_id_str</span><span class="p">]</span>
        <span class="n">slice_key_uri</span> <span class="o">=</span> <span class="n">user_ns</span><span class="p">[</span><span class="n">slice_key_id</span><span class="p">]</span>

        <span class="c1"># Copy the DSD graph into a fresh row_graph</span>
        <span class="n">row_graph</span> <span class="o">=</span> <span class="n">dsd_graph</span><span class="o">.</span><span class="vm">__class__</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">ns_obj</span> <span class="ow">in</span> <span class="n">ns_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">row_graph</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">ns_obj</span><span class="p">)</span>
        <span class="n">row_graph</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;skos&#39;</span><span class="p">,</span> <span class="n">SKOS</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">triple</span> <span class="ow">in</span> <span class="n">dsd_graph</span><span class="p">:</span>
            <span class="n">row_graph</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">triple</span><span class="p">)</span>

        <span class="c1"># qb:DataSet</span>
        <span class="n">row_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">dataset_uri</span><span class="p">,</span> <span class="n">RDF</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">DataSet</span><span class="p">))</span>
        <span class="n">row_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">dataset_uri</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">dsd_uri</span><span class="p">))</span>
        <span class="n">row_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">dataset_uri</span><span class="p">,</span> <span class="n">DCTERMS</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">Literal</span><span class="p">(</span><span class="n">dataset_id_str</span><span class="p">)))</span>
        <span class="n">row_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">dataset_uri</span><span class="p">,</span> <span class="n">DCTERMS</span><span class="o">.</span><span class="n">creator</span><span class="p">,</span> <span class="n">Literal</span><span class="p">(</span><span class="n">orcid</span><span class="p">)))</span>

        <span class="c1"># Single SliceKey for these dimensions</span>
        <span class="n">row_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">slice_key_uri</span><span class="p">,</span> <span class="n">RDF</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">SliceKey</span><span class="p">))</span>
        <span class="n">fixed_dimensions</span> <span class="o">=</span> <span class="n">dimensions</span>
        <span class="k">for</span> <span class="n">dim_name</span> <span class="ow">in</span> <span class="n">fixed_dimensions</span><span class="p">:</span>
            <span class="n">dim_prop</span> <span class="o">=</span> <span class="n">get_property_uri</span><span class="p">(</span><span class="n">dim_name</span><span class="p">,</span> <span class="n">variable_metadata</span><span class="p">[</span><span class="n">dim_name</span><span class="p">],</span> <span class="n">ns_map</span><span class="p">,</span> <span class="n">user_ns</span><span class="p">)</span>
            <span class="n">row_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">slice_key_uri</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">componentProperty</span><span class="p">,</span> <span class="n">dim_prop</span><span class="p">))</span>

        <span class="c1"># Single Slice</span>
        <span class="n">row_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">slice_uri</span><span class="p">,</span> <span class="n">RDF</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">Slice</span><span class="p">))</span>
        <span class="n">row_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">slice_uri</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">sliceStructure</span><span class="p">,</span> <span class="n">slice_key_uri</span><span class="p">))</span>
        <span class="n">row_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">dataset_uri</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">slice</span><span class="p">,</span> <span class="n">slice_uri</span><span class="p">))</span>

        <span class="n">not_found_uri</span> <span class="o">=</span> <span class="n">user_ns</span><span class="p">[</span><span class="s1">&#39;NotFound&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">dim_name</span> <span class="ow">in</span> <span class="n">fixed_dimensions</span><span class="p">:</span>
            <span class="n">dim_val</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dim_name</span><span class="p">)</span>
            <span class="n">dim_meta</span> <span class="o">=</span> <span class="n">variable_metadata</span><span class="p">[</span><span class="n">dim_name</span><span class="p">]</span>
            <span class="n">dim_prop</span> <span class="o">=</span> <span class="n">get_property_uri</span><span class="p">(</span><span class="n">dim_name</span><span class="p">,</span> <span class="n">dim_meta</span><span class="p">,</span> <span class="n">ns_map</span><span class="p">,</span> <span class="n">user_ns</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">dim_val</span><span class="p">):</span>
                <span class="n">row_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">slice_uri</span><span class="p">,</span> <span class="n">dim_prop</span><span class="p">,</span> <span class="n">Literal</span><span class="p">(</span><span class="n">dim_val</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">row_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">slice_uri</span><span class="p">,</span> <span class="n">dim_prop</span><span class="p">,</span> <span class="n">not_found_uri</span><span class="p">))</span>

        <span class="c1"># Observations</span>
        <span class="n">obs_counter</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">variable_dims</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">observations</span><span class="p">,</span> <span class="n">obs_counter</span> <span class="o">=</span> <span class="n">create_observation</span><span class="p">(</span>
            <span class="n">row_graph</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">variable_metadata</span><span class="p">,</span> <span class="n">variable_dims</span><span class="p">,</span> <span class="n">measures</span><span class="p">,</span> <span class="n">ns_map</span><span class="p">,</span> <span class="n">user_ns</span><span class="p">,</span> <span class="n">obs_counter</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">obs_uri</span> <span class="ow">in</span> <span class="n">observations</span><span class="p">:</span>
            <span class="n">row_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">slice_uri</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">observation</span><span class="p">,</span> <span class="n">obs_uri</span><span class="p">))</span>

        <span class="c1"># Write to subfolders</span>
        <span class="n">subfolders</span> <span class="o">=</span> <span class="n">create_subfolders</span><span class="p">(</span><span class="n">root_folder_path</span><span class="p">)</span>
        <span class="n">ttl_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subfolders</span><span class="p">[</span><span class="s2">&quot;ttl&quot;</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">combined_file</span><span class="si">}</span><span class="s2">.ttl&quot;</span><span class="p">)</span>
        <span class="n">jsonld_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subfolders</span><span class="p">[</span><span class="s2">&quot;jsonld&quot;</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">combined_file</span><span class="si">}</span><span class="s2">.jsonld&quot;</span><span class="p">)</span>
        <span class="n">hash_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subfolders</span><span class="p">[</span><span class="s2">&quot;hash&quot;</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">combined_file</span><span class="si">}</span><span class="s2">.jsonld.sha256&quot;</span><span class="p">)</span>

        <span class="n">row_graph</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">destination</span><span class="o">=</span><span class="n">ttl_path</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;turtle&#39;</span><span class="p">)</span>
        <span class="n">row_graph</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">destination</span><span class="o">=</span><span class="n">jsonld_path</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;json-ld&#39;</span><span class="p">,</span> <span class="n">auto_compact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># compute hash</span>
        <span class="n">file_hash</span> <span class="o">=</span> <span class="n">compute_file_hash</span><span class="p">(</span><span class="n">jsonld_path</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">hash_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hf</span><span class="p">:</span>
            <span class="n">hf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_hash</span><span class="p">)</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1">#          ROW-BY-ROW FOR CRADLE</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="convert_row_by_row_CRADLE">
<a class="viewcode-back" href="../../../FAIRLinked.QBWorkflow.html#FAIRLinked.QBWorkflow.rdf_transformer.convert_row_by_row_CRADLE">[docs]</a>
<span class="k">def</span> <span class="nf">convert_row_by_row_CRADLE</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">variable_metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">ns_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">user_chosen_prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">orcid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">root_folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">overall_timestamp</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description:</span>
<span class="sd">        Converts each row of a DataFrame into its own qb:DataSet in RDF, prompting the user</span>
<span class="sd">        to choose which ID columns to incorporate in naming. Each row-based dataset shares</span>
<span class="sd">        the same folder timestamp to keep them grouped.</span>

<span class="sd">    Algorithm:</span>
<span class="sd">        1) Identify candidate ID columns (contain &#39;id&#39;), pass &#39;row-by-row&#39; to get_approved_id_columns(...).</span>
<span class="sd">        2) Extract which columns are dimensions vs. measures =&gt; create a single DSD for entire DF.</span>
<span class="sd">        3) For each row =&gt; build a new Graph that:</span>
<span class="sd">            - Copies the DSD</span>
<span class="sd">            - Creates a new qb:DataSet =&gt; mds:Dataset_{someIDs}_{orcid}_{timestamp}</span>
<span class="sd">            - Creates a SliceKey =&gt; mds:SliceKey_{someIDs}_{orcid}_{timestamp}</span>
<span class="sd">            - Creates a Slice =&gt; mds:Slice_{someIDs}_{orcid}_{timestamp}</span>
<span class="sd">            - Adds Observations for each measure</span>
<span class="sd">        4) Write each row&#39;s TTL/JSON-LD + .sha256 hash in subfolders.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (pd.DataFrame): The entire DataFrame to convert row-by-row.</span>
<span class="sd">        variable_metadata (dict): column =&gt; metadata dictionary.</span>
<span class="sd">        ns_map (dict): prefix =&gt; Namespace mapping.</span>
<span class="sd">        user_chosen_prefix (str): e.g. &#39;mds&#39;.</span>
<span class="sd">        orcid (str): The user&#39;s ORCID, from which we extract digits.</span>
<span class="sd">        root_folder_path (str): The top-level folder for outputs.</span>
<span class="sd">        overall_timestamp (str): The run&#39;s global timestamp for consistent naming.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user_ns</span> <span class="o">=</span> <span class="n">ns_map</span><span class="p">[</span><span class="n">user_chosen_prefix</span><span class="p">]</span>


    <span class="n">approved_id_cols</span> <span class="o">=</span> <span class="n">get_row_identifier_columns</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>

    <span class="c1"># Build a single DSD for entire DF</span>
    <span class="c1"># dimensions, measures = extract_variables(variable_metadata, df.columns)</span>
    <span class="c1"># if EXPERIMENT_ID_COLUMN in df.columns and EXPERIMENT_ID_COLUMN not in dimensions:</span>
    <span class="c1">#     dimensions.insert(0, EXPERIMENT_ID_COLUMN)</span>

    <span class="c1"># dsd_graph, dsd_uri = create_dsd(variable_metadata, dimensions, measures, ns_map, user_ns)</span>

    <span class="c1"># For each row =&gt; new dataset</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="c1"># naming: from approved ID columns</span>
        <span class="n">name_parts_file</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">name_parts_iri</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">approved_id_cols</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">])</span> <span class="k">else</span> <span class="s2">&quot;NotFound&quot;</span>
            <span class="n">name_parts_file</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_sanitize_for_filename</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
            <span class="n">name_parts_iri</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_sanitize_for_iri</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>

        <span class="n">numeric_orcid</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span> <span class="n">orcid</span><span class="p">))</span>

        <span class="c1"># fallback =&gt; orcid + timestamp</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">name_parts_file</span><span class="p">):</span>
            <span class="n">combined_file</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name_parts_file</span> <span class="o">+</span> <span class="p">[</span><span class="n">numeric_orcid</span><span class="p">,</span> <span class="n">overall_timestamp</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">combined_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">numeric_orcid</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">overall_timestamp</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">letter</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span><span class="p">)</span>
        <span class="n">combined_file</span> <span class="o">=</span> <span class="n">letter</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">combined_file</span>
        
        <span class="n">row_graph</span> <span class="o">=</span> <span class="n">create_observation_2</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span>
                       <span class="n">variable_metadata</span><span class="o">=</span><span class="n">variable_metadata</span><span class="p">,</span>
                       <span class="n">ns_map</span><span class="o">=</span><span class="n">ns_map</span><span class="p">,</span>
                       <span class="n">user_ns</span><span class="o">=</span><span class="n">user_ns</span><span class="p">,</span>
                       <span class="n">file_name</span><span class="o">=</span><span class="n">combined_file</span><span class="p">)</span>

        

        <span class="c1"># if any(name_parts_iri):</span>
        <span class="c1">#     combined_iri = &quot;-&quot;.join(name_parts_iri + [numeric_orcid, overall_timestamp])</span>
        <span class="c1"># else:</span>
        <span class="c1">#     combined_iri = f&quot;{numeric_orcid}-{overall_timestamp}&quot;</span>
        <span class="c1"># combined_iri = letter + &quot;-&quot; + combined_iri</span>

        <span class="c1"># dataset_id_str = &quot;Dataset&quot; + &quot;-&quot; + combined_iri</span>
        <span class="c1"># slice_id_str = &quot;Slice&quot; + &quot;-&quot; + combined_iri</span>
        <span class="c1"># slice_key_id = &quot;SliceKey&quot; + &quot;-&quot; + combined_iri</span>

        <span class="c1"># dataset_uri = user_ns[dataset_id_str]</span>
        <span class="c1"># slice_uri = user_ns[slice_id_str]</span>
        <span class="c1"># slice_key_uri = user_ns[slice_key_id]</span>

        <span class="c1"># # Copy the DSD graph into a fresh row_graph</span>
        <span class="c1"># row_graph = dsd_graph.__class__()</span>
        <span class="c1"># for prefix, ns_obj in ns_map.items():</span>
        <span class="c1">#     row_graph.bind(prefix, ns_obj)</span>
        <span class="c1"># row_graph.bind(&#39;skos&#39;, SKOS)</span>
        <span class="c1"># for triple in dsd_graph:</span>
        <span class="c1">#     row_graph.add(triple)</span>

        <span class="c1"># # qb:DataSet</span>
        <span class="c1"># row_graph.add((dataset_uri, RDF.type, QB.DataSet))</span>
        <span class="c1"># row_graph.add((dataset_uri, QB.structure, dsd_uri))</span>
        <span class="c1"># row_graph.add((dataset_uri, DCTERMS.title, Literal(dataset_id_str)))</span>
        <span class="c1"># row_graph.add((dataset_uri, DCTERMS.creator, Literal(orcid)))</span>

        <span class="c1"># # Single SliceKey for these dimensions</span>
        <span class="c1"># row_graph.add((slice_key_uri, RDF.type, QB.SliceKey))</span>
        <span class="c1"># fixed_dimensions = dimensions</span>
        <span class="c1"># for dim_name in fixed_dimensions:</span>
        <span class="c1">#     dim_prop = get_property_uri(dim_name, variable_metadata[dim_name], ns_map, user_ns)</span>
        <span class="c1">#     row_graph.add((slice_key_uri, QB.componentProperty, dim_prop))</span>

        <span class="c1"># # Single Slice</span>
        <span class="c1"># row_graph.add((slice_uri, RDF.type, QB.Slice))</span>
        <span class="c1"># row_graph.add((slice_uri, QB.sliceStructure, slice_key_uri))</span>
        <span class="c1"># row_graph.add((dataset_uri, QB.slice, slice_uri))</span>

        <span class="c1"># not_found_uri = user_ns[&#39;NotFound&#39;]</span>
        <span class="c1"># for dim_name in fixed_dimensions:</span>
        <span class="c1">#     dim_val = row.get(dim_name)</span>
        <span class="c1">#     dim_meta = variable_metadata[dim_name]</span>
        <span class="c1">#     dim_prop = get_property_uri(dim_name, dim_meta, ns_map, user_ns)</span>
        <span class="c1">#     if pd.notnull(dim_val):</span>
        <span class="c1">#         row_graph.add((slice_uri, dim_prop, Literal(dim_val)))</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         row_graph.add((slice_uri, dim_prop, not_found_uri))</span>

        <span class="c1"># # Observations</span>
        <span class="c1"># obs_counter = 1</span>
        <span class="c1"># variable_dims = []</span>
        <span class="c1"># observations, obs_counter = create_observation(</span>
        <span class="c1">#     row_graph, row, variable_metadata, variable_dims, measures, ns_map, user_ns, obs_counter</span>
        <span class="c1"># )</span>
        <span class="c1"># for obs_uri in observations:</span>
        <span class="c1">#     row_graph.add((slice_uri, QB.observation, obs_uri))</span>

        <span class="c1"># Write to subfolders</span>
        <span class="n">subfolders</span> <span class="o">=</span> <span class="n">create_subfolders</span><span class="p">(</span><span class="n">root_folder_path</span><span class="p">)</span>
        <span class="n">ttl_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subfolders</span><span class="p">[</span><span class="s2">&quot;ttl&quot;</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">combined_file</span><span class="si">}</span><span class="s2">.ttl&quot;</span><span class="p">)</span>
        <span class="n">jsonld_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subfolders</span><span class="p">[</span><span class="s2">&quot;jsonld&quot;</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">combined_file</span><span class="si">}</span><span class="s2">.jsonld&quot;</span><span class="p">)</span>
        <span class="n">hash_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subfolders</span><span class="p">[</span><span class="s2">&quot;hash&quot;</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">combined_file</span><span class="si">}</span><span class="s2">.jsonld.sha256&quot;</span><span class="p">)</span>

        <span class="n">row_graph</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">destination</span><span class="o">=</span><span class="n">ttl_path</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;turtle&#39;</span><span class="p">)</span>
        <span class="n">row_graph</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">destination</span><span class="o">=</span><span class="n">jsonld_path</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;json-ld&#39;</span><span class="p">,</span> <span class="n">auto_compact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


        <span class="c1"># compute hash</span>
        <span class="n">file_hash</span> <span class="o">=</span> <span class="n">compute_file_hash</span><span class="p">(</span><span class="n">jsonld_path</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">hash_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hf</span><span class="p">:</span>
            <span class="n">hf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_hash</span><span class="p">)</span></div>



<span class="c1"># =============================================================================</span>
<span class="c1">#          ENTIRE-DATASET CONVERSION</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="convert_entire_dataset">
<a class="viewcode-back" href="../../../FAIRLinked.QBWorkflow.html#FAIRLinked.QBWorkflow.rdf_transformer.convert_entire_dataset">[docs]</a>
<span class="k">def</span> <span class="nf">convert_entire_dataset</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">variable_metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">ns_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">user_chosen_prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">dataset_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">orcid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_folder_paths</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">fixed_dimensions</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">overall_timestamp</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description:</span>
<span class="sd">        Converts the entire DataFrame into a single qb:DataSet, and each row becomes</span>
<span class="sd">        a qb:Slice. Observations are created for each measure in each row. </span>
<span class="sd">        If user picks ID columns =&gt; these become part of the slice&#39;s name.</span>

<span class="sd">    Algorithm:</span>
<span class="sd">        1) Identify columns with &#39;id&#39;. Prompt user with mode=&#39;entire&#39; =&gt; get_approved_id_columns(...).</span>
<span class="sd">        2) Create a DataStructureDefinition for the entire DF =&gt; dimensions + measures.</span>
<span class="sd">        3) Add a single qb:DataSet =&gt; e.g. mds:Dataset_{datasetName}.</span>
<span class="sd">        4) Create a single qb:SliceKey referencing dimension properties.</span>
<span class="sd">        5) For each row =&gt; create qb:Slice =&gt; name derived from (someIDs + orcid + timestamp).</span>
<span class="sd">        6) Within that slice =&gt; create Observations (one per measure).</span>
<span class="sd">        7) Write a single .ttl/.jsonld + .sha256 hash to the respective subfolders.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (pd.DataFrame): The entire dataset in tabular form.</span>
<span class="sd">        variable_metadata (dict): column =&gt; metadata dictionary.</span>
<span class="sd">        ns_map (dict): prefix =&gt; rdflib.Namespace</span>
<span class="sd">        user_chosen_prefix (str): e.g. &#39;mds&#39;</span>
<span class="sd">        dataset_name (str): e.g. &#39;SampleDataset&#39; (already sanitized or not).</span>
<span class="sd">        orcid (str): The user&#39;s ORCID from which we parse digits for naming.</span>
<span class="sd">        output_folder_paths (dict): subfolders =&gt; their paths.</span>
<span class="sd">        fixed_dimensions (list or None): optionally specify columns that remain fixed in every slice.</span>
<span class="sd">        overall_timestamp (str or None): If provided, used for consistent naming across slices.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">rdflib</span> <span class="kn">import</span> <span class="n">Graph</span>
    <span class="n">user_ns</span> <span class="o">=</span> <span class="n">ns_map</span><span class="p">[</span><span class="n">user_chosen_prefix</span><span class="p">]</span>

    <span class="n">candidate_id_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)]</span>
    <span class="n">approved_id_cols</span> <span class="o">=</span> <span class="n">get_approved_id_columns</span><span class="p">(</span><span class="n">candidate_id_cols</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;entire&#39;</span><span class="p">)</span>

    <span class="n">safe_iri_name</span>  <span class="o">=</span> <span class="n">_sanitize_for_iri</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">)</span>
    <span class="n">safe_file_name</span> <span class="o">=</span> <span class="n">_sanitize_for_filename</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">)</span>

    <span class="n">dimensions</span><span class="p">,</span> <span class="n">measures</span> <span class="o">=</span> <span class="n">extract_variables</span><span class="p">(</span><span class="n">variable_metadata</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">EXPERIMENT_ID_COLUMN</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">EXPERIMENT_ID_COLUMN</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dimensions</span><span class="p">:</span>
        <span class="n">dimensions</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">EXPERIMENT_ID_COLUMN</span><span class="p">)</span>

    <span class="n">dsd_graph</span><span class="p">,</span> <span class="n">dsd_uri</span> <span class="o">=</span> <span class="n">create_dsd</span><span class="p">(</span><span class="n">variable_metadata</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">,</span> <span class="n">measures</span><span class="p">,</span> <span class="n">ns_map</span><span class="p">,</span> <span class="n">user_ns</span><span class="p">)</span>

    <span class="n">entire_graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">ns_obj</span> <span class="ow">in</span> <span class="n">ns_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">entire_graph</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">ns_obj</span><span class="p">)</span>
    <span class="n">entire_graph</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;skos&#39;</span><span class="p">,</span> <span class="n">SKOS</span><span class="p">)</span>

    <span class="c1"># copy the DSD</span>
    <span class="k">for</span> <span class="n">triple</span> <span class="ow">in</span> <span class="n">dsd_graph</span><span class="p">:</span>
        <span class="n">entire_graph</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">triple</span><span class="p">)</span>

    <span class="n">dataset_uri_str</span> <span class="o">=</span> <span class="n">_sanitize_for_iri</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset_</span><span class="si">{</span><span class="n">safe_iri_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">dataset_uri</span> <span class="o">=</span> <span class="n">user_ns</span><span class="p">[</span><span class="n">dataset_uri_str</span><span class="p">]</span>
    <span class="n">entire_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">dataset_uri</span><span class="p">,</span> <span class="n">RDF</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">DataSet</span><span class="p">))</span>
    <span class="n">entire_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">dataset_uri</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">dsd_uri</span><span class="p">))</span>
    <span class="n">entire_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">dataset_uri</span><span class="p">,</span> <span class="n">DCTERMS</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">Literal</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">)))</span>
    <span class="n">entire_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">dataset_uri</span><span class="p">,</span> <span class="n">DCTERMS</span><span class="o">.</span><span class="n">creator</span><span class="p">,</span> <span class="n">Literal</span><span class="p">(</span><span class="n">orcid</span><span class="p">)))</span>

    <span class="n">global_slice_key_str</span> <span class="o">=</span> <span class="n">_sanitize_for_iri</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SliceKey_</span><span class="si">{</span><span class="n">safe_iri_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">global_slice_key_uri</span> <span class="o">=</span> <span class="n">user_ns</span><span class="p">[</span><span class="n">global_slice_key_str</span><span class="p">]</span>
    <span class="n">entire_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">global_slice_key_uri</span><span class="p">,</span> <span class="n">RDF</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">SliceKey</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">fixed_dimensions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fixed_dimensions</span> <span class="o">=</span> <span class="n">dimensions</span>

    <span class="k">for</span> <span class="n">dim_name</span> <span class="ow">in</span> <span class="n">fixed_dimensions</span><span class="p">:</span>
        <span class="n">dim_prop</span> <span class="o">=</span> <span class="n">get_property_uri</span><span class="p">(</span><span class="n">dim_name</span><span class="p">,</span> <span class="n">variable_metadata</span><span class="p">[</span><span class="n">dim_name</span><span class="p">],</span> <span class="n">ns_map</span><span class="p">,</span> <span class="n">user_ns</span><span class="p">)</span>
        <span class="n">entire_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">global_slice_key_uri</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">componentProperty</span><span class="p">,</span> <span class="n">dim_prop</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">overall_timestamp</span><span class="p">:</span>
        <span class="n">overall_timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">)</span>
    <span class="n">numeric_orcid</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span> <span class="n">orcid</span><span class="p">))</span>

    <span class="n">observation_counter</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">not_found_uri</span> <span class="o">=</span> <span class="n">user_ns</span><span class="p">[</span><span class="s1">&#39;NotFound&#39;</span><span class="p">]</span>

    <span class="c1"># Build slices for each row</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">name_parts_for_iri</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">approved_id_cols</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">])</span> <span class="k">else</span> <span class="s2">&quot;NotFound&quot;</span>
            <span class="n">name_parts_for_iri</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_sanitize_for_iri</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">name_parts_for_iri</span><span class="p">):</span>
            <span class="n">slice_key_iri</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name_parts_for_iri</span> <span class="o">+</span> <span class="p">[</span><span class="n">numeric_orcid</span><span class="p">,</span> <span class="n">overall_timestamp</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">slice_key_iri</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">numeric_orcid</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">overall_timestamp</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">slice_key_iri</span> <span class="o">=</span> <span class="n">_sanitize_for_iri</span><span class="p">(</span><span class="n">slice_key_iri</span><span class="p">)</span>

        <span class="n">slice_id_str</span> <span class="o">=</span> <span class="n">_sanitize_for_iri</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Slice_</span><span class="si">{</span><span class="n">slice_key_iri</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">slice_uri</span> <span class="o">=</span> <span class="n">user_ns</span><span class="p">[</span><span class="n">slice_id_str</span><span class="p">]</span>

        <span class="n">entire_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">slice_uri</span><span class="p">,</span> <span class="n">RDF</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">Slice</span><span class="p">))</span>
        <span class="n">entire_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">slice_uri</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">sliceStructure</span><span class="p">,</span> <span class="n">global_slice_key_uri</span><span class="p">))</span>
        <span class="n">entire_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">dataset_uri</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">slice</span><span class="p">,</span> <span class="n">slice_uri</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">dim_name</span> <span class="ow">in</span> <span class="n">fixed_dimensions</span><span class="p">:</span>
            <span class="n">dim_val</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dim_name</span><span class="p">)</span>
            <span class="n">dim_meta</span> <span class="o">=</span> <span class="n">variable_metadata</span><span class="p">[</span><span class="n">dim_name</span><span class="p">]</span>
            <span class="n">dim_prop</span> <span class="o">=</span> <span class="n">get_property_uri</span><span class="p">(</span><span class="n">dim_name</span><span class="p">,</span> <span class="n">dim_meta</span><span class="p">,</span> <span class="n">ns_map</span><span class="p">,</span> <span class="n">user_ns</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">dim_val</span><span class="p">):</span>
                <span class="n">entire_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">slice_uri</span><span class="p">,</span> <span class="n">dim_prop</span><span class="p">,</span> <span class="n">Literal</span><span class="p">(</span><span class="n">dim_val</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">entire_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">slice_uri</span><span class="p">,</span> <span class="n">dim_prop</span><span class="p">,</span> <span class="n">not_found_uri</span><span class="p">))</span>

        <span class="n">variable_dimensions</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dimensions</span> <span class="k">if</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fixed_dimensions</span><span class="p">]</span>
        <span class="n">obs_list</span><span class="p">,</span> <span class="n">observation_counter</span> <span class="o">=</span> <span class="n">create_observation</span><span class="p">(</span>
            <span class="n">entire_graph</span><span class="p">,</span>
            <span class="n">row</span><span class="p">,</span>
            <span class="n">variable_metadata</span><span class="p">,</span>
            <span class="n">variable_dimensions</span><span class="p">,</span>
            <span class="n">measures</span><span class="p">,</span>
            <span class="n">ns_map</span><span class="p">,</span>
            <span class="n">user_ns</span><span class="p">,</span>
            <span class="n">observation_counter</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">obs_uri</span> <span class="ow">in</span> <span class="n">obs_list</span><span class="p">:</span>
            <span class="n">entire_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">slice_uri</span><span class="p">,</span> <span class="n">QB</span><span class="o">.</span><span class="n">observation</span><span class="p">,</span> <span class="n">obs_uri</span><span class="p">))</span>

    <span class="c1"># Write out single TTL/JSON-LD + hash</span>
    <span class="n">ttl_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder_paths</span><span class="p">[</span><span class="s2">&quot;ttl&quot;</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_file_name</span><span class="si">}</span><span class="s2">.ttl&quot;</span><span class="p">)</span>
    <span class="n">jsonld_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder_paths</span><span class="p">[</span><span class="s2">&quot;jsonld&quot;</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_file_name</span><span class="si">}</span><span class="s2">.jsonld&quot;</span><span class="p">)</span>
    <span class="n">hash_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder_paths</span><span class="p">[</span><span class="s2">&quot;hash&quot;</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_file_name</span><span class="si">}</span><span class="s2">.jsonld.sha256&quot;</span><span class="p">)</span>

    <span class="n">entire_graph</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">destination</span><span class="o">=</span><span class="n">ttl_path</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;turtle&#39;</span><span class="p">)</span>
    <span class="n">entire_graph</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">destination</span><span class="o">=</span><span class="n">jsonld_path</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;json-ld&#39;</span><span class="p">,</span> <span class="n">auto_compact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">file_hash</span> <span class="o">=</span> <span class="n">compute_file_hash</span><span class="p">(</span><span class="n">jsonld_path</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">hash_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hash_file</span><span class="p">:</span>
        <span class="n">hash_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_hash</span><span class="p">)</span></div>




<span class="c1"># =============================================================================</span>
<span class="c1">#           MASTER FUNCTION</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="convert_dataset_to_rdf_with_mode">
<a class="viewcode-back" href="../../../FAIRLinked.QBWorkflow.html#FAIRLinked.QBWorkflow.rdf_transformer.convert_dataset_to_rdf_with_mode">[docs]</a>
<span class="k">def</span> <span class="nf">convert_dataset_to_rdf_with_mode</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">variable_metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">namespace_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">user_chosen_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">DEFAULT_USER_PREFIX</span><span class="p">,</span>
    <span class="n">output_folder_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span>
    <span class="n">orcid</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="n">dataset_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">DEFAULT_DATASET_NAME</span><span class="p">,</span>
    <span class="n">fixed_dimensions</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">conversion_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;entire&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description:</span>
<span class="sd">        Main entry point for converting a Pandas DataFrame to RDF using either:</span>
<span class="sd">         - &#39;entire&#39;: single qb:DataSet with multiple qb:Slices</span>
<span class="sd">         - &#39;row-by-row&#39;: each row =&gt; a separate qb:DataSet</span>
<span class="sd">        Also writes a naming conventions .txt file describing how URIs and filenames are formed.</span>

<span class="sd">    Algorithm:</span>
<span class="sd">        1) create_root_folder =&gt; get a top-level folder named &quot;Output_{orcidDigits}_{timestamp}&quot;.</span>
<span class="sd">        2) prepare_namespaces =&gt; validate prefix =&gt; namespace URIs.</span>
<span class="sd">        3) If conversion_mode == &#39;entire&#39;:</span>
<span class="sd">             a) create_subfolders =&gt; &#39;ttl&#39;, &#39;jsonld&#39;, &#39;hash&#39;</span>
<span class="sd">             b) build combined_iri =&gt; dataset_name_for_iri</span>
<span class="sd">             c) call convert_entire_dataset(...)</span>
<span class="sd">           elif conversion_mode == &#39;row-by-row&#39;:</span>
<span class="sd">             call convert_row_by_row(...)</span>
<span class="sd">           else:</span>
<span class="sd">             raise ValueError if mode is invalid</span>
<span class="sd">        4) write_naming_conventions_doc =&gt; describing the chosen naming approach</span>
<span class="sd">        5) Print success message.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (pd.DataFrame): The data to convert.</span>
<span class="sd">        variable_metadata (dict): column =&gt; metadata (like IsMeasure, Unit, Category, etc.).</span>
<span class="sd">        namespace_map (dict): prefix =&gt; base URI for RDF</span>
<span class="sd">        user_chosen_prefix (str): e.g. &#39;mds&#39;</span>
<span class="sd">        output_folder_path (str): base folder path for new output folder</span>
<span class="sd">        orcid (str): user’s ORCID</span>
<span class="sd">        dataset_name (str): used if &#39;entire&#39; mode</span>
<span class="sd">        fixed_dimensions (list or None): used in entire mode to specify columns that</span>
<span class="sd">                                         remain the same across slices</span>
<span class="sd">        conversion_mode (str): &#39;entire&#39; or &#39;row-by-row&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># 1) create the root folder</span>
        <span class="n">root_folder_path</span><span class="p">,</span> <span class="n">overall_timestamp</span><span class="p">,</span> <span class="n">sanitized_dataset_name</span><span class="p">,</span> <span class="n">sanitized_orcid</span> <span class="o">=</span> <span class="n">create_root_folder</span><span class="p">(</span>
            <span class="n">output_folder_path</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">,</span> <span class="n">orcid</span>
        <span class="p">)</span>

        <span class="c1"># 2) prepare namespaces</span>
        <span class="n">ns_map</span> <span class="o">=</span> <span class="n">prepare_namespaces</span><span class="p">(</span><span class="n">namespace_map</span><span class="p">,</span> <span class="n">user_chosen_prefix</span><span class="p">)</span>

        <span class="c1"># 3) entire or row-by-row</span>
        <span class="k">if</span> <span class="n">conversion_mode</span> <span class="o">==</span> <span class="s1">&#39;entire&#39;</span><span class="p">:</span>
            <span class="n">subfolders</span> <span class="o">=</span> <span class="n">create_subfolders</span><span class="p">(</span><span class="n">root_folder_path</span><span class="p">)</span>
            <span class="n">combined_iri</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sanitized_dataset_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sanitized_orcid</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">overall_timestamp</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">dataset_name_for_iri</span> <span class="o">=</span> <span class="n">_sanitize_for_iri</span><span class="p">(</span><span class="n">combined_iri</span><span class="p">)</span>

            <span class="n">convert_entire_dataset</span><span class="p">(</span>
                <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                <span class="n">variable_metadata</span><span class="o">=</span><span class="n">variable_metadata</span><span class="p">,</span>
                <span class="n">ns_map</span><span class="o">=</span><span class="n">ns_map</span><span class="p">,</span>
                <span class="n">user_chosen_prefix</span><span class="o">=</span><span class="n">user_chosen_prefix</span><span class="p">,</span>
                <span class="n">dataset_name</span><span class="o">=</span><span class="n">dataset_name_for_iri</span><span class="p">,</span>
                <span class="n">orcid</span><span class="o">=</span><span class="n">orcid</span><span class="p">,</span>
                <span class="n">output_folder_paths</span><span class="o">=</span><span class="n">subfolders</span><span class="p">,</span>
                <span class="n">fixed_dimensions</span><span class="o">=</span><span class="n">fixed_dimensions</span><span class="p">,</span>
                <span class="n">overall_timestamp</span><span class="o">=</span><span class="n">overall_timestamp</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">conversion_mode</span> <span class="o">==</span> <span class="s1">&#39;row-by-row&#39;</span><span class="p">:</span>
            <span class="n">convert_row_by_row</span><span class="p">(</span>
                <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                <span class="n">variable_metadata</span><span class="o">=</span><span class="n">variable_metadata</span><span class="p">,</span>
                <span class="n">ns_map</span><span class="o">=</span><span class="n">ns_map</span><span class="p">,</span>
                <span class="n">user_chosen_prefix</span><span class="o">=</span><span class="n">user_chosen_prefix</span><span class="p">,</span>
                <span class="n">orcid</span><span class="o">=</span><span class="n">orcid</span><span class="p">,</span>
                <span class="n">root_folder_path</span><span class="o">=</span><span class="n">root_folder_path</span><span class="p">,</span>
                <span class="n">overall_timestamp</span><span class="o">=</span><span class="n">overall_timestamp</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">conversion_mode</span> <span class="o">==</span> <span class="s2">&quot;CRADLE&quot;</span><span class="p">:</span>
            <span class="n">convert_row_by_row_CRADLE</span><span class="p">(</span>
                <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                <span class="n">variable_metadata</span><span class="o">=</span><span class="n">variable_metadata</span><span class="p">,</span>
                <span class="n">ns_map</span><span class="o">=</span><span class="n">ns_map</span><span class="p">,</span>
                <span class="n">user_chosen_prefix</span><span class="o">=</span><span class="n">user_chosen_prefix</span><span class="p">,</span>
                <span class="n">orcid</span><span class="o">=</span><span class="n">orcid</span><span class="p">,</span>
                <span class="n">root_folder_path</span><span class="o">=</span><span class="n">root_folder_path</span><span class="p">,</span>
                <span class="n">overall_timestamp</span><span class="o">=</span><span class="n">overall_timestamp</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid conversion_mode. Choose &#39;entire&#39; or &#39;row-by-row&#39;.&quot;</span><span class="p">)</span>

        <span class="c1"># 4) Write naming conventions doc</span>
        <span class="n">write_naming_conventions_doc</span><span class="p">(</span>
             <span class="n">root_folder_path</span><span class="o">=</span><span class="n">root_folder_path</span><span class="p">,</span>
             <span class="n">conversion_mode</span><span class="o">=</span><span class="n">conversion_mode</span><span class="p">,</span>
             <span class="n">orcid</span><span class="o">=</span><span class="n">orcid</span><span class="p">,</span>
             <span class="n">overall_timestamp</span><span class="o">=</span><span class="n">overall_timestamp</span><span class="p">,</span>
             <span class="n">dataset_name</span><span class="o">=</span><span class="n">sanitized_dataset_name</span>
         <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Conversion completed under mode=&#39;</span><span class="si">{</span><span class="n">conversion_mode</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Outputs in: </span><span class="si">{</span><span class="n">root_folder_path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An error occurred during RDF conversion: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Van D. Tran, Ritika Lamba, Balashanmuga Priyan Rajamohan, Gabriel Ponon, Kai Zheng, Benjamin Pierce, Quynh D. Tran, Ozan Dernek, Erika I. Barcelos, Roger H. French.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>